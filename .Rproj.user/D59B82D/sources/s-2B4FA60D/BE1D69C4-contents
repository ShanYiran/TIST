options(stringsAsFactors = F )
library(plyr)
library(network)
library(tidygraph)
library(igraph)
library(ggraph)
library(scales)
library(STRINGdb)
library(Seurat)
library(progress)
library(lattice)
#library(tidyverse)
library(ggplot2)
library(Matrix)
#library(Rmisc)
library(ggforce)
library(VennDiagram)
library(rjson)
library(cowplot)
library(RColorBrewer)
library(grid)
library(sp)

#library(readbitmap)
library(ggExtra)
library(reshape2)
library(gridExtra)
library(sctransform)
library(pheatmap)
library(Hmisc)#???Ø°?
library(magick)
library(imager)
library(seewave)
library(MASS)
library(NbClust)
library(clv)
library(SPARK)
library(parallel)
library(doParallel)
library(foreach)
library(pracma)
library(CompQuadForm)
library(philentropy)
library(data.table)
#cell interaction
library(CellChat)
library(ggplot2)
library(ggalluvial)
library(svglite)
library(Seurat)
library(mindr)
library(NMF)
library(xlsx)
library(matrixStats)
library(parallel)
library(ggpubr)
library(TIST)
library(CellChat)

#C1 example
#
#Maskfile <- "D:/Gu_lab/space_expr/data/225987_D1/spatial/Imginit/mask1.txt"
#imagefile <- "D:/Gu_lab/space_expr/data/225987_D1/spatial/tissue_hires_image.png"
#savePath <- "D:/Gu_lab/space_expr/data/225987_D1/metacell_results/"
#spaceFile <- "D:/Gu_lab/space_expr/data/225987_D1/spatial/tissue_positions_list.csv"
#barcodefile = "D:/Gu_lab/space_expr/data/225987_D1/spatial/Imginit/barcodes.tsv"
#exprPath = "D:/Gu_lab/space_expr/data/225987_D1/filtered_feature_bc_matrix/"

#sacle_score <- 0.09455371
#netfile <- paste0(savePath,"ST_img_unsupnet.RDS")
#supervised

Maskfile_ <- c("D:/Gu_lab/space_expr/data/pubdata/V1_Human_Heart/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/pubdata/V1_Human_Lymph_Node/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Brain_Sagittal_Anterior/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Brain_Sagittal_Posterior/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Kidney/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/084717_A/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/084717_B/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/084717_C/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/084717_D/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/2006524_M/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/2006582_M/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/2006654_M/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/2006735_M/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/cHC-1L/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/cHC-1N/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/cHC-1T/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-1L/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-1N/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-1T/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-2L/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-2N/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-2P/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-2T/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-3L/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-3N/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-3T/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-4L/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-4N/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-4T/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-6L/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-6N/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-6T/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/Our_data/ICC-1L/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/Liver/Data/ST_data/72HB/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/Liver/Data/ST_data/40H/outs/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/Liver/Data/ST_data/D7B_new/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/Liver/Data/ST_data/0HB_new/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/Liver/Data/ST_data/0HB/outs/spatial/Imginit/mask1.txt"

)
imagefile_ <- c("D:/Gu_lab/space_expr/data/pubdata/V1_Human_Heart/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/pubdata/V1_Human_Lymph_Node/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Brain_Sagittal_Anterior/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Brain_Sagittal_Posterior/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Kidney/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/084717_A/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/084717_B/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/084717_C/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/084717_D/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/2006524_M/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/2006582_M/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/2006654_M/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/2006735_M/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/cHC-1L/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/cHC-1N/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/cHC-1T/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-1L/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-1N/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-1T/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-2L/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-2N/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-2P/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-2T/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-3L/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-3N/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-3T/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-4L/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-4N/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-4T/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-6L/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-6N/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-6T/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/Our_data/ICC-1L/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/Liver/Data/ST_data/72HB/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/Liver/Data/ST_data/40H/outs/spatial/tissue_hires_image.png",
                "D:/Gu_lab/Liver/Data/ST_data/D7B_new/spatial/tissue_hires_image.png",
                "D:/Gu_lab/Liver/Data/ST_data/0HB_new/spatial/tissue_hires_image.png",
                "D:/Gu_lab/Liver/Data/ST_data/0HB/outs/spatial/tissue_hires_image.png"
)
savePath_ <- c("D:/Gu_lab/space_expr/data/pubdata/V1_Human_Heart/metacell_results/",
               "D:/Gu_lab/space_expr/data/pubdata/V1_Human_Lymph_Node/metacell_results/",
               "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Brain_Sagittal_Anterior/metacell_results/",
               "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Brain_Sagittal_Posterior/metacell_results/",
               "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Kidney/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/084717_A/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/084717_B/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/084717_C/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/084717_D/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/2006524_M/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/2006582_M/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/2006654_M/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/2006735_M/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/cHC-1L/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/cHC-1N/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/cHC-1T/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-1L/outs/metacell_results3/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-1N/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-1T/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-2L/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-2N/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-2P/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-2T/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-3L/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-3N/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-3T/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-4L/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-4N/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-4T/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-6L/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-6N/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/HCC-6T/outs/metacell_results/",
               "D:/Gu_lab/space_expr/data/Our_data/ICC-1L/outs/metacell_results/",
               "D:/Gu_lab/Liver/Data/ST_data/72HB/outs/metacell_results/",
               "D:/Gu_lab/Liver/Data/ST_data/40H/outs/metacell_results/",
               "D:/Gu_lab/Liver/Data/ST_data/D7B_new/metacell_results/",
               "D:/Gu_lab/Liver/Data/ST_data/0HB_new/metacell_results/",
               "D:/Gu_lab/Liver/Data/ST_data/0HB/outs/metacell_results/"

)
spaceFile_ <- c("D:/Gu_lab/space_expr/data/pubdata/V1_Human_Heart/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/pubdata/V1_Human_Lymph_Node/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Brain_Sagittal_Anterior/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Brain_Sagittal_Posterior/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Kidney/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/084717_A/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/084717_B/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/084717_C/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/084717_D/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/2006524_M/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/2006582_M/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/2006654_M/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/2006735_M/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/cHC-1L/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/cHC-1N/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/cHC-1T/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-1L/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-1N/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-1T/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-2L/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-2N/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-2P/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-2T/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-3L/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-3N/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-3T/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-4L/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-4N/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-4T/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-6L/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-6N/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/HCC-6T/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/Our_data/ICC-1L/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/Liver/Data/ST_data/72HB/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/Liver/Data/ST_data/40H/outs/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/Liver/Data/ST_data/D7B_new/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/Liver/Data/ST_data/0HB_new/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/Liver/Data/ST_data/0HB/outs/spatial/tissue_positions_list.csv"
)
barcodefile_ = c("D:/Gu_lab/space_expr/data/pubdata/V1_Human_Heart/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/pubdata/V1_Human_Lymph_Node/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Brain_Sagittal_Anterior/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Brain_Sagittal_Posterior/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Kidney/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/084717_A/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/084717_B/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/084717_C/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/084717_D/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/2006524_M/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/2006582_M/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/2006654_M/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/2006735_M/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/cHC-1L/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/cHC-1N/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/cHC-1T/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-1L/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-1N/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-1T/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-2L/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-2N/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-2P/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-2T/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-3L/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-3N/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-3T/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-4L/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-4N/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-4T/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-6L/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-6N/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/HCC-6T/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/Our_data/ICC-1L/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/Liver/Data/ST_data/72HB/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/Liver/Data/ST_data/40H/outs/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/Liver/Data/ST_data/D7B_new/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/Liver/Data/ST_data/0HB_new/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/Liver/Data/ST_data/0HB/outs/spatial/Imginit/barcodes.tsv"
)
exprPath_ = c("D:/Gu_lab/space_expr/data/pubdata/V1_Human_Heart/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/pubdata/V1_Human_Lymph_Node/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Brain_Sagittal_Anterior/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Brain_Sagittal_Posterior/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/pubdata/V1_Mouse_Kidney/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/084717_A/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/084717_B/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/084717_C/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/084717_D/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/2006524_M/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/2006582_M/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/2006654_M/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/2006735_M/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/cHC-1L/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/cHC-1N/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/cHC-1T/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-1L/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-1N/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-1T/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-2L/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-2N/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-2P/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-2T/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-3L/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-3N/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-3T/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-4L/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-4N/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-4T/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-6L/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-6N/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/HCC-6T/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/Our_data/ICC-1L/outs/filtered_feature_bc_matrix/",
              "D:/Gu_lab/Liver/Data/ST_data/72HB/outs/filtered_feature_bc_matrix",
              "D:/Gu_lab/Liver/Data/ST_data/40H/outs/filtered_feature_bc_matrix",
              "D:/Gu_lab/Liver/Data/ST_data/D7B_new/filtered_feature_bc_matrix",
              "D:/Gu_lab/Liver/Data/ST_data/0HB_new/filtered_feature_bc_matrix",
              "D:/Gu_lab/Liver/Data/ST_data/0HB/outs/filtered_feature_bc_matrix"
)

sacle_score_ <- c(0.150015,0.17011142,0.17211704,0.17211704,0.17699115,0.11363637,
                  0.11792453,0.11061947,0.116171,0.10813149,0.10539629,0.10781671,
                  0.11320541,0.09920635,0.11531366,0.09455371,0.09735203,0.11792453,
                  0.09904913,0.11343013,0.10813149,0.11331445,0.1077296,0.1146789,
                  0.11682243,0.1108156,0.113352984,0.11344943,0.11346874,0.1108156,
                  0.10813149,0.1108156,0.10775862,0.6142506, 0.6142506,0.2402691,0.2402691,0.6142506)


#for Mouse Brain

Maskfile <- "D:/Gu_lab/space_expr/data/pubdata/V1_Adult_Mouse_Brain/spatial/Imginit/mask1.txt"
imagefile <- "D:/Gu_lab/space_expr/data/pubdata/V1_Adult_Mouse_Brain/spatial/tissue_hires_image.png"
savePath <- "D:/Gu_lab/space_expr/data/pubdata/V1_Adult_Mouse_Brain/test_package_results/"
spaceFile <- "D:/Gu_lab/space_expr/data/pubdata/V1_Adult_Mouse_Brain/spatial/tissue_positions_list.csv"
barcodefile = "D:/Gu_lab/space_expr/data/pubdata/V1_Adult_Mouse_Brain/spatial/Imginit/barcodes.tsv"
exprPath = "D:/Gu_lab/space_expr/data/pubdata/V1_Adult_Mouse_Brain/filtered_feature_bc_matrix/"

sacle_score <- 0.17011142




for(i in 6:length(barcodefile_)){
  if(i==17)next
  Maskfile <- Maskfile_[i]
  imagefile <-imagefile_[i]
  savePath <- savePath_[i]
  spaceFile <- spaceFile_[i]
  barcodefile = barcodefile_[i]
  exprPath = exprPath_[i]
  sacle_score <- sacle_score_[i]
  netfile <- paste0(savePath,"ST_imgunsupnet.RDS")

  #img and seqRNA unsuper
  print(Sys.time())
  Spot_manifest_imgunsup <- Meta_St_img_unsupervised(Maskfile = Maskfile,
                                                     imagefile = imagefile,
                                                     spaceFile = spaceFile,
                                                     exprPath = exprPath,
                                                     colors = NULL,
                                                     savePath = savePath,
                                                     Method = "walktrap",
                                                     sacle_score = sacle_score)
  print(Sys.time())
  Mc_manifest <- Meta_expr_matrix(exprPath = exprPath,Spot_manifest = Spot_manifest_imgunsup,
                                  imagefile = imagefile,
                                  savePath = savePath,merge_method = "mean")
  SC_obj_file <- paste0(savePath,"expr_obj.RDS")
  MD_marker_file <- paste0(savePath,"MD_markers.RDS")
  MC_obj_file <- paste0(savePath,"Mc_obj.RDS")
  MC_ident_file <- paste0(savePath,"MC_idents.RDS")
  netfile <- paste0(savePath,"ST_imgunsupnet.RDS")
  SPARK_file <- paste0(savePath,"SPARK.rds")
  mc_marker_plot(gl = NULL,MC_obj_file,Mc_manifest,Spot_manifest_imgunsup,savePath)
  Spark_methods(exprPath,
                spaceFile,
                savePath)
  SC_obj <- readRDS(SC_obj_file)
  SpaceDiffGene(SC_obj = SC_obj,
                Spot_manifest= Spot_manifest_imgunsup,
                savePath = savePath,
                MC_obj_file = MC_obj_file,
                Mc_manifest = Mc_manifest,
                methods= "walktrap",
                Mc_name = Mc_name,
                SPARK_file = SPARK_file,
                netfile = netfile)

}

Gl <- c('Spink8',
        'Slc17a6',
        'Kcne2',
        'Prkcd',
        'Crlf1',
        'Slc6a11',
        'Ctxn3',
        'Baiap3',
        'Cbln4',
        'Mfge8',
        'Gpx3',
        'Fam163b',
        'Hap1',
        'Rora',
        '1110008P14Rik',
        'Meig1',
        'Arpp21',
        'Ndn',
        'Cabp7',
        'Adarb1',
        'Ttr',
        'Mbp',
        'Rarres2',
        'Ptgds',
        'Lrrc10b',
        'Dsp',
        'Mef2c',
        'Adcy1',
        'Atp2b1',
        'Neurod6',
        '6330403K07Rik',
        'Amotl1',
        'Snap25',
        'Dynlrb2',
        'Lamp5',
        'Tbr1',
        'Ramp3',
        'Resp18',
        'C1ql2',
        'Agt',
        'Plp1',
        'Folr1',
        'Camk2n1',
        'Cfh',
        'Camk2a',
        'Rasgrf2',
        'Mgp',
        'Ccdc153',
        'Mobp',
        'Ahi1',
        'Cbln1',
        'Nptxr',
        'Arpc5',
        'Tmem212',
        'Col1a2',
        'Hpcal1',
        'Klk8',
        'Ddn',
        'Lypd1',
        '3110035E14Rik',
        'Hpca',
        'Kl',
        'Icam5',
        'Neurl1a',
        'Dclk1',
        'Mal',
        'Epop',
        'Enpp2',
        'Tcf7l2',
        'Slc6a13',
        'Cnp',
        'Zcchc12',
        'Sparc')

new_path <- "D:/Gu_lab/space_expr/data/pubdata/V1_Adult_Mouse_Brain/metacell_results/new_gene_plot/"
space <- Spot_manifest
rownames(space) <- Spot_manifest$barcode
for(i in 1:length(d)){
  dd <- d[i]
  #dir.create(paste0(new_path,"Diffusion",dd,'/'))
  savePath_ <- paste0(new_path,"Diffusion",dd,'/')

  dataPath <-paste0(savePath,"Diffusion_d",dd,'_b4/')
  diffusion_matrix <- readRDS(paste0(dataPath,"diffusion_matrix.RDS"))
  ST_net <- readRDS(paste0(dataPath,"ST_imgunsupnet.RDS"))
  gl <- intersect(Gl, rownames(diffusion_matrix))
  for(j in 1:length(gl)){
    gg <- gl[j]
    id <-diffusion_matrix[gg,]
    #id <- Dc
    #id[which(id==max(id))] = mean(id)
    id <- abs(id)
    pltdat <- cbind(Spot_manifest[, c("imagerow","imagecol")],id)
    colnames(pltdat)[1:2] <- c("y","x")
    pltdat$y = -pltdat$y
    xpand = 0
    ypand = 1
    pal <- colorRampPalette(c("#ADADAD", "#EEB4B4", "#7A378B"))
    p <- ggplot(pltdat, aes(x = x, y = y, color = id)) + geom_point(size = 3)+ scale_color_gradientn(colours = pal(5)) +scale_x_discrete(expand = c(xpand, ypand)) + scale_y_discrete(expand = c(xpand, ypand)) + coord_equal() +

      # labs(title = colnames(pd)[igene+2], x = NULL, y = NULL)+
      theme_bw()
    ggsave(filename = paste0(savePath_,gg,"_before.png"), p,
           width = 8, height = 7, dpi = 500)
    x_e <-diffusion_matrix[gg,]
    names(x_e) <- ST_filter_str( colnames(SC_obj@assays$RNA@data),'-')
    x_e <- x_e+0.1
    for(k in 1:dim(space)[1]){
      this_node <- names(x_e)[k]
      this_n <- neighbors(ST_net,this_node)

      tm <-x_e[names(this_n)]
      if(length(tm)>1){x_e[k] <- mean(tm)}
      else x_e[k] <- 0.1
    }
    x_e <- as.vector(x_e)

    id <-x_e
    #id <- Dc
    #id[which(id==max(id))] = mean(id)
    id <- abs(id)
    pltdat <- cbind(Spot_manifest[, c("imagerow","imagecol")],id)
    colnames(pltdat)[1:2] <- c("y","x")
    pltdat$y = -pltdat$y
    xpand = 0
    ypand = 1
    pal <- colorRampPalette(c("#ADADAD", "#EEB4B4", "#7A378B"))
    p <- ggplot(pltdat, aes(x = x, y = y, color = id)) + geom_point(size = 3)+ scale_color_gradientn(colours = pal(5)) +scale_x_discrete(expand = c(xpand, ypand)) + scale_y_discrete(expand = c(xpand, ypand)) + coord_equal() +

      # labs(title = colnames(pd)[igene+2], x = NULL, y = NULL)+
      theme_bw()
    ggsave(filename = paste0(savePath_,gg,"_after.png"), p,
           width = 8, height = 7, dpi = 500)

  }


}



Dropout_net_analysis(SC_obj = SC_obj,
                     Spot_manifest = Spot_manifest_imgunsup,
                     savePath = savePath,
                     spaceFile =spaceFile,
                     Maskfile = Maskfile,
                     imagefile = imagefile,
                     spot_r_min = 12,
                     img_import = 1,
                     spot_r_max = 20,
                     dropout_rate = dd,
                     enrichment_score = TRUE,
                     netfile = netfile,
                     geneenrichment = T,
                     genelist = NULL)


d <- c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9)

#Diffusion
for(i in 1:length(d)){
  dd <- d[i]
  print(Sys.time())
  Diffusion_net_analysis(SC_obj=SC_obj,
                         Spot_manifest = Spot_manifest_imgunsup,
                         savePath= savePath,
                         centre = 1,
                         broad = 2,
                         spaceFile=spaceFile,
                         Maskfile=Maskfile,
                         imagefile=imagefile,
                         spot_r_min = 12,
                         img_import = 1,
                         spot_r_max = 20,
                         Step = NULL,
                         diffusion_rate = dd,
                         enrichment_score = TRUE,
                         netfile = netfile,
                         geneenrichment = T,
                         genelist = NULL)
  print(Sys.time())
}
#Dropout


SC_obj_file <- paste0(savePath,"expr_obj.RDS")
MD_marker_file <- paste0(savePath,"MD_markers.RDS")
MC_obj_file <- paste0(savePath,"Mc_obj.RDS")
MC_ident_file <- paste0(savePath,"MC_idents.RDS")
netfile <- paste0(savePath,"ST_img_unsup_net.RDS")
SPARK_file <- paste0(savePath,"SPARK.rds")
mc_marker_plot(gl = NULL,MC_obj_file,Mc_manifest,Spot_manifest_imgunsup,savePath)
Matching_analysis(SC_obj_file,
                  Spot_manifest,
                  Mc_manifest,
                  MC_obj_file,
                  MC_ident_file,
                  savePath,
                  netfile,
                  res_rate = 0.5,
                  plot_res_net = F,
                  pair_ana = F,
                  marker_pair_ana = F)
SC_obj <- readRDS(SC_obj_file)
Spark_methods(exprPath,
              spaceFile,
              savePath)
SpaceDiffGene(SC_obj,
              Spot_manifest= Spot_manifest_imgunsup,
              savePath,
              MC_obj_file,
              Mc_manifest,
              methods= "walktrap",
              Mc_name,
              SPARK_file)

 #only imgunsup
for(i in 3:length(barcodefile_)){
  Maskfile <- Maskfile_[i]
  imagefile <-imagefile_[i]
  savePath <- savePath_[i]
  spaceFile <- spaceFile_[i]
  barcodefile = barcodefile_[i]
  exprPath = exprPath_[i]
  sacle_score <- sacle_score_[i]
  netfile <- paste0(savePath,"ST_imgunsupnet.RDS")
  #supervised


  Spot_manifest <- Features_score(exprPath,
                                  spaceFile,
                                  savePath)

  Spot_manifest <- CellTyepscore2Celltype(Spot_manifest = Spot_manifest,colors = NULL,
                                          savePath = savePath)
  Spot_manifest_imgunsup <- readRDS(paste0(savePath,"Spot_manifest_imgunsup.RDS"))
  Mc_manifest <- Meta_expr_matrix(exprPath = exprPath,Spot_manifest = Spot_manifest_imgunsup,
                                  ct_id = Spot_manifest,mc_id = Spot_manifest_imgunsup,
                                  savePath = savePath,imagefile = imagefile)
  SC_obj_file <- paste0(savePath,"Spot_obj_mcid.RDS")
  MC_obj_file <- paste0(savePath,"Mc_obj.RDS")
  MC_ident_file <- paste0(savePath,"MC_idents.RDS")
  netfile <- paste0(savePath,"ST_imgunsupnet.RDS")
  MD_marker_file <- paste0(savePath,"Mc_markers.RDS")
  #mc_marker_plot(gl,MC_obj_file,Mc_manifest,Spot_manifest_imgunsup,savePath)
  Matching_analysis(SC_obj_file,
                    Spot_manifest,
                    Mc_manifest,
                    MC_obj_file,
                    MC_ident_file,
                    savePath,
                    netfile,
                    res_rate = 0.5,
                    plot_res_net = F,
                    pair_ana = F,
                    marker_pair_ana = T)
  Cell_interaction(SC_obj_file,
                   Spot_manifest = Spot_manifest_imgunsup,
                   savePath,
                   org = "m",
                   Signal = "Secreted Signaling")
  MD_recluster(Spot_manifest = Spot_manifest_imgunsup,
               savePath,
               MC_obj_file,
               MC_ident_file,
               resolution = 1,
               MD_marker_file = NULL)
  Plot_all_resnet(SC_obj,netfile,
                  Spot_manifest = Spot_manifest_imgunsup,
                  MC_ident_file = MC_ident_file,
                  savePath = paste0(savePath,"tm/"),
                  Mc_name_list=Mc_manifest$mc_names[1:10],
                  gene_name_list = MD_gene$gene,
                  res_rate = 0.5)

}


for(i in 4:length(barcodefile_)){
  savePath <- savePath_[i]
  spaceFile <- spaceFile_[i]
  exprPath = exprPath_[i]
  Spark_methods(exprPath,
                spaceFile,
                savePath)
}


#diff gene analysis

spark <- readRDS(paste0(savePath,"SPARK.rds"))
spark_gene <- rownames(spark@counts)
MD_gene <- readRDS(paste0(savePath,"Mc_markers.RDS"))
MD_gene <- MD_gene %>% group_by(cluster) %>% top_n(n = 100, wt = avg_logFC)
MD_gene <- MD_gene$gene

gl_int <- intersect(spark_gene,MD_gene)
gl_MD <- setdiff(MD_gene,gl_int)
gl_spark <- setdiff(spark_gene,gl_int)
feature_plot(gene_plot = gl_MD ,SC_obj, Spot_manifest,savePath)
mc_marker_plot(gl_MD,MC_obj_file,Mc_manifest,Spot_manifest,savePath)

#low umap show
MC_obj <- readRDS(MC_obj_file)
Mc_manifest <- readRDS(paste0(savePath,"Mc_manifest.RDS"))
tm <- runUMAP(MC_obj@assays$RNA@scale.data)
Mc_manifest <- cbind(Mc_manifest,tm)
expr_obj <- readRDS(paste0(savePath,"Spot_obj_mcid.RDS"))
tm <- data.frame(barcode = ST_filter_str(colnames(expr_obj),'-'),mc= Idents(expr_obj))
Spot_manifest <- readRDS(paste0(savePath,"Spot_manifest_imgunsup.RDS"))
Spot_manifest <- merge(Spot_manifest,tm,Idents(expr_obj),by.x = "barcode",by.y = "barcode")
mc_id <- Spot_manifest$mc
col <- array(getDefaultColors(length(table(mc_id))))
rownames(col) <- names(table(Spot_manifest$mc))

ggplot(Mc_manifest, aes(x = mc_y, y = -mc_x, color = mc_names)) + geom_point(size = 2) +
  scale_colour_manual(values = col) + scale_x_discrete(expand = c(0.09,0.09)) + scale_y_discrete(expand = c(0.09,0.09)) + coord_equal() +  theme_bw() +
  xlab("x") + ylab("y")



############new################
colon <- readRDS("D:/Gu_lab/space_expr/data/pubdata/liver/Colon_10um_annotated.rds")


for(i in 37:length(barcodefile_)){
  Maskfile <- Maskfile_[i]
  imagefile <-imagefile_[i]
  savePath <- savePath_[i]
  spaceFile <- spaceFile_[i]
  barcodefile = barcodefile_[i]
  exprPath = exprPath_[i]
  sacle_score <- sacle_score_[i]
  netfile <- paste0(savePath,"ST_imgunsupnet.RDS")
  #supervised


  Spot_manifest <- Features_score(exprPath,
                                  spaceFile,
                                  savePath)

  Spot_manifest <- CellTyepscore2Celltype(Spot_manifest = Spot_manifest,colors = NULL,
                                          savePath = savePath)
  Spot_manifest_imgunsup <- readRDS(paste0(savePath,"Spot_manifest_imgunsup.RDS"))
  Mc_manifest <- Meta_expr_matrix(exprPath = exprPath,Spot_manifest = Spot_manifest_imgunsup,
                                  ct_id = Spot_manifest,mc_id = Spot_manifest_imgunsup,
                                  savePath = savePath,imagefile = imagefile)
  SC_obj_file <- paste0(savePath,"Spot_obj_mcid.RDS")
  MC_obj_file <- paste0(savePath,"Mc_obj.RDS")
  MC_ident_file <- paste0(savePath,"MC_idents.RDS")
  netfile <- paste0(savePath,"ST_imgunsupnet.RDS")
  MD_marker_file <- paste0(savePath,"Mc_markers.RDS")
  #mc_marker_plot(gl,MC_obj_file,Mc_manifest,Spot_manifest_imgunsup,savePath)
  Matching_analysis(SC_obj_file,
                    Spot_manifest_imgunsup,
                    Mc_manifest,
                    MC_obj_file,
                    MC_ident_file,
                    savePath,
                    netfile,
                    plot_res_net = F,
                    pair_ana = F,
                    marker_pair_ana = F)

}




Maskfile_ <- c("D:/Gu_lab/space_expr/data/pubdata/Human_OvarianCancer/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/pubdata/Human_Cerebellum_Neuroscience/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/pubdata/Human_SpinalCord/spatial/Imginit/mask1.txt",
               "D:/Gu_lab/space_expr/data/pubdata/V1_Breast_Cancer_Block_A_Section_1/spatial/Imginit/mask1.txt"
)
imagefile_ <- c("D:/Gu_lab/space_expr/data/pubdata/Human_OvarianCancer/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/pubdata/Human_Cerebellum_Neuroscience/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/pubdata/Human_SpinalCord/spatial/tissue_hires_image.png",
                "D:/Gu_lab/space_expr/data/pubdata/V1_Breast_Cancer_Block_A_Section_1/spatial/tissue_hires_image.png"
)
savePath_ <- c("D:/Gu_lab/space_expr/data/pubdata/Human_OvarianCancer/metacell_results/",
               "D:/Gu_lab/space_expr/data/pubdata/Human_Cerebellum_Neuroscience/metacell_results/",
               "D:/Gu_lab/space_expr/data/pubdata/Human_SpinalCord/metacell_results/",
               "D:/Gu_lab/space_expr/data/pubdata/V1_Breast_Cancer_Block_A_Section_1/metacell_results/"

)
spaceFile_ <- c("D:/Gu_lab/space_expr/data/pubdata/Human_OvarianCancer/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/pubdata/Human_Cerebellum_Neuroscience/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/pubdata/Human_SpinalCord/spatial/tissue_positions_list.csv",
                "D:/Gu_lab/space_expr/data/pubdata/V1_Breast_Cancer_Block_A_Section_1/spatial/tissue_positions_list.csv"
)
barcodefile_ = c("D:/Gu_lab/space_expr/data/pubdata/Human_OvarianCancer/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/pubdata/Human_Cerebellum_Neuroscience/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/pubdata/Human_SpinalCord/spatial/Imginit/barcodes.tsv",
                 "D:/Gu_lab/space_expr/data/pubdata/V1_Breast_Cancer_Block_A_Section_1/spatial/Imginit/barcodes.tsv"
)
exprPath_ = c("D:/Gu_lab/space_expr/data/pubdata/Human_OvarianCancer/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/pubdata/Human_Cerebellum_Neuroscience/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/pubdata/Human_SpinalCord/filtered_feature_bc_matrix/",
              "D:/Gu_lab/space_expr/data/pubdata/V1_Breast_Cancer_Block_A_Section_1/filtered_feature_bc_matrix/"
)

sacle_score_ <- c(0.08250825,0.150015,0.45004502,0.08250825)




generate_mask <- function(imagefile,
                          savePath,
                          sacle_score,
                          spaceFile,
                          spot_r_max = 20){
  img <- load.image(imagefile)
  im <- grayscale(img) %>% isoblur(2)
  plot(im)

  Spot_space <- read.csv(file = spaceFile,header = F)
  sel.cols <- c("barcode","tissue", "row", "col", "imagerow", "imagecol")
  colnames(Spot_space) <- sel.cols
  Spot_space$barcode <- ST_filter_str(Spot_space$barcode,'-')
  mask <- zeros(dim(im)[1],dim(im)[2])
  for(i in 1:length(Spot_space$barcode)){
    ximgrow = round(Spot_space[i,"imagerow"]*sacle_score)
    ximgcol = round(Spot_space[i,"imagecol"]*sacle_score)
    mask[(ximgcol-spot_r_max):(ximgcol+spot_r_max),(ximgrow-spot_r_max):(ximgrow+spot_r_max)] = 1
  }
  write.table(mask,paste0(savePath,"mask1.txt"),quote = F,row.names = F,col.names = F,sep = ',')
}
